
{% extends "base.html" %}
{% load static %}

{% block main %}
{% comment %} 
<style>
    
    h3 {
        font-weight: bold;
        color: #005f73;
    }
    
    .d-flex {
        display: flex;
        gap: 20px;
    }
    
    .camera-feed {
        border-radius: 10px;
        border: 2px solid #0077b6;
        width: 100%;
        max-width: 640px;
    }
    
    .attendance-list {
        flex: 1;
        max-width: 1000px;
    }
    
    .table-wrapper {
        max-height: 400px; 
        overflow-y: auto; 
        border: 1px solid #ccc;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        border: 1px solid #0077b6;
        padding: 8px;
        text-align: center;
    }
    
    th {
        background-color: #0077b6;
        color: white;
    }
    
    button {
        border-radius: 5px;
        font-size: 16px;
    }    
</style> {% endcomment %}
<style>
    /* Gi·ªØ nguy√™n style g·ªëc */
    h3 {
        font-weight: bold;
        color: #005f73;
    }

    .d-flex {
        display: flex;
        gap: 20px;
    }

    .camera-feed {
        border-radius: 10px;
        border: 2px solid #0077b6;
        width: 100%;
        max-width: 640px;
    }

    .attendance-list {
        flex: 1;
        max-width: 1000px;
    }

    .table-wrapper {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
    }

    th {
        background-color: #0077b6;
        color: white;
    }

    th, td {
        border: 1px solid #0077b6;
        padding: 8px;
        text-align: center;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
        .d-flex {
            flex-direction: column; /* X·∫øp d·ªçc */
            align-items: center;
            gap: 15px;
        }

        .camera-feed {
            max-width: 100%; /* Chi·∫øm to√†n chi·ªÅu r·ªông */
        }

        .attendance-list {
            max-width: 100%;
        }

        .table-wrapper {
            max-height: 300px; /* Gi·∫£m chi·ªÅu cao cho mobile */
        }

        th, td {
            padding: 6px; /* Gi·∫£m padding */
            font-size: 0.9rem; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
        }

        button {
            padding: 8px 15px; /* N√∫t nh·ªè h∆°n */
            font-size: 0.9rem;
        }
    }

    @media (max-width: 576px) {
        h3 {
            font-size: 1.5rem; /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
        }

        th, td {
            padding: 4px;
            font-size: 0.8rem;
        }

        button {
            padding: 6px 10px;
        }
    }
</style>
<div class="container-fluid text-center">
    <h3 class="text-dark mb-4">·ª®ng d·ª•ng ƒëi·ªÉm danh nh·∫≠n di·ªán khu√¥n m·∫∑t</h3>
    <div class="d-flex justify-content-between">
        <div class="card shadow p-4" style="flex: 1;">
            <div class="card-body">
                <img src="{% url 'video_feed' %}" width="640" height="480" class="camera-feed">
                <div class="mt-3">
                    <button id="diemDanhButton" class="btn btn-primary" onclick="toggleDiemDanh()">ƒêi·ªÉm danh</button>
                </div>
                <div id="message" class="mt-3 font-weight-bold"></div>
            </div>
        </div>

        <div class="card shadow p-4 attendance-list">
            <h4>Danh s√°ch sinh vi√™n ƒëi·ªÉm danh</h4>
            <div class="table-wrapper">
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>MSSV</th>
                            <th>T√™n</th>
                            <th>L·ªõp</th>
                            <th>Khoa</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card shadow mt-4 p-4">
        <h4 class="text-center">ƒêi·ªÉm danh th·ªß c√¥ng</h4>
        <form id="manualOpenForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="manual_mssv">M√£ SV:</label>
                <input type="text" id="manual_mssv" name="manual_mssv" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="username">T√†i kho·∫£n:</label>
                <input type="text" id="username" name="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u:</label>
                <input type="password" id="password" name="password" class="form-control" required>
            </div>
            <button type="button" class="btn btn-success mt-2" onclick="manualOpen()">üîì X√°c nh·∫≠n m·ªü c·ª≠a</button>
        </form>
        <div id="manualMessage" class="mt-3 font-weight-bold"></div>
    </div> 
</div>

        <div class="card shadow mt-4 p-4">
            <h4 class="text-center">Th√™m sinh vi√™n m·ªõi</h4>
            <form id="addStudentForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="mssv">M√£ SV:</label>
                    <input type="text" id="mssv" name="mssv" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="name">T√™n:</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lop">L·ªõp:</label>
                    <select id="lop" name="lop" class="form-control" required>
                        <option value="K56KMT">K56KMT</option>
                        <option value="K57KMT">K57KMT</option>
                        <option value="K58KMT">K58KMT</option>
                        <option value="K59KMT">K59KMT</option>
                        {% for lop in danh_sach_lop %}
                            <option value="{{ lop }}">{{ lop }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="khoa">Khoa:</label>
                    <select id="khoa" name="khoa" class="form-control" required>
                        <option value="dientu">ƒêi·ªán t·ª≠</option>
                        <option value="kinhte">Kinh t·∫ø</option>
                        <option value="dien">ƒêi·ªán</option>
                        {% for khoa in danh_sach_khoa %}
                            <option value="{{ khoa }}">{{ khoa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="images">Ch·ªçn ·∫£nh:</label>
                    <input type="file" id="images" name="images" class="form-control" multiple accept="image/*" required>
                </div>
                <div class="text-center mt-2">
                    <button type="button" class="btn btn-primary" onclick="captureImage()">üì∑ Ch·ª•p ·∫£nh</button>
                </div>

                <!-- Hi·ªÉn th·ªã video ƒë·ªÉ ch·ª•p ·∫£nh -->
                <video id="cameraPreview" autoplay style="width: 100%; display: none;"></video>

                <!-- Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·ª•p -->
                <div id="capturedImages" class="mt-2"></div>
                <button type="button" class="btn btn-info mt-2" onclick="addStudent()">Th√™m ng∆∞·ªùi</button>
            </form>
        </div>
        <div class="card shadow mt-4 p-4">
            <h4 class="text-center">Th√™m sinh vi√™n b·∫±ng th∆∞ m·ª•c</h4>
            <form id="addFolderForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="folderInput">Ch·ªçn th∆∞ m·ª•c:</label>
                    <input type="file" id="folderInput" webkitdirectory directory class="form-control" required>
                </div>
                <button type="button" class="btn btn-success mt-2" onclick="addFolder()">Th√™m th∆∞ m·ª•c</button>
            </form>
            <div id="folderMessage" class="mt-3 font-weight-bold"></div>
        </div>        
    </div>

    <script>
        let diemDanhDangChay = false;
        let intervalId = null;

        function getCSRFToken() {
            let cookieValue = null;
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    cookieValue = cookie.substring('csrftoken='.length, cookie.length);
                    break;
                }
            }
            return cookieValue;
        }

        function toggleDiemDanh() {
            let button = document.getElementById("diemDanhButton");
            let messageDiv = document.getElementById("message");
        
            if (!diemDanhDangChay) {
                button.innerText = "D·ª´ng";
                button.classList.remove("btn-primary");
                button.classList.add("btn-danger");
                diemDanhDangChay = true;
        
                intervalId = setInterval(() => {
                    fetch("{% url 'mark_attendance' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success === true) {  // Explicitly check success key
                            messageDiv.innerText = "‚úÖ ƒê√£ ƒëi·ªÉm danh th√†nh c√¥ng!";
                            messageDiv.style.color = "green";
                            loadDiemDanhList();  // Refresh the attendance list
                        } else {
                            messageDiv.innerText = data.message || "‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t!";
                            messageDiv.style.color = "red";
                        }
                    })
                    .catch(error => {
                        console.error('L·ªói:', error);
                        messageDiv.innerText = "‚ùå L·ªói h·ªá th·ªëng!";
                        messageDiv.style.color = "red";
                    });
                }, 5000);
        
            } else {
                button.innerText = "ƒêi·ªÉm danh";
                button.classList.remove("btn-danger");
                button.classList.add("btn-primary");
                diemDanhDangChay = false;
                clearInterval(intervalId);
                messageDiv.innerText = "";  // Clear message when stopping
            }
        }
        
        loadDiemDanhList();

        let videoStream = null;
        let capturedImages = [];
        let imageCount = 0;

        function captureImage() {
            if (imageCount >= 5) {
                alert("ƒê√£ ch·ª•p ƒë·ªß 5 ·∫£nh!");
                return;
            }
        
            let video = document.querySelector(".camera-feed"); // Ch·ªçn video feed nh·∫≠n di·ªán khu√¥n m·∫∑t
            let canvas = document.createElement("canvas");
            canvas.width = video.width;
            canvas.height = video.height;
            let ctx = canvas.getContext("2d");
        
            // Ch·ª•p ·∫£nh t·ª´ video nh·∫≠n di·ªán khu√¥n m·∫∑t
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
            // Chuy·ªÉn ·∫£nh th√†nh file Blob
            canvas.toBlob(blob => {
                let file = new File([blob], `captured_${imageCount + 1}.jpg`, { type: "image/jpeg" });
                capturedImages.push(file);
                imageCount++;
        
                // Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·ª•p
                let imgElement = document.createElement("img");
                imgElement.src = URL.createObjectURL(blob);
                imgElement.style.width = "100px";
                imgElement.classList.add("m-2");
                document.getElementById("capturedImages").appendChild(imgElement);
        
                if (imageCount >= 5) {
                    alert("ƒê√£ ch·ª•p ƒë·ªß 5 ·∫£nh!");
                }
            }, "image/jpeg");
        }
        
// G·ª≠i d·ªØ li·ªáu sinh vi√™n l√™n server
function addStudent() {
    let formData = new FormData(document.getElementById('addStudentForm'));

    // N·∫øu c√≥ ·∫£nh ch·ª•p, th√™m v√†o FormData
    if (capturedImages.length === 5) {
        capturedImages.forEach((file, index) => {
            formData.append(`images`, file);
        });
    }

    fetch("{% url 'them_sv' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        let messageDiv = document.getElementById('message');
        messageDiv.innerText = data.message || data.error;
        messageDiv.style.color = data.message ? 'green' : 'red';

        if (data.message) {
            document.getElementById("addStudentForm").reset();
            document.getElementById("capturedImages").innerHTML = "";
        }
    })
    .catch(error => console.error('L·ªói:', error));
    loadDiemDanhList();
}
        
        function loadDiemDanhList() {
            fetch("{% url 'diemdanh_list' %}")
                .then(response => response.json())
                .then(data => {
                    let tableBody = document.getElementById('attendanceTableBody');
                    tableBody.innerHTML = '';  

                    data.forEach(record => {
                        let row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.mssv}</td>
                            <td>${record.name}</td>
                            <td>${record.lop}</td>
                            <td>${record.Khoa}</td>
                            <td>${record.time}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('L·ªói:', error));
        }
        function addFolder() {
            let folderInput = document.getElementById("folderInput");
            let files = folderInput.files;
            
            if (files.length === 0) {
                alert("Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c!");
                return;
            }
        
            // L·∫•y t√™n th∆∞ m·ª•c ƒë·∫ßu ti√™n (ƒë·ªÉ tr√≠ch xu·∫•t MSSV, t√™n, l·ªõp, khoa)
            let folderName = files[0].webkitRelativePath.split("/")[0];
        
            let formData = new FormData();
            formData.append("folder_name", folderName);
        
            fetch("{% url 'add_folder' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken()
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let messageDiv = document.getElementById("folderMessage");
                messageDiv.innerText = data.message || data.error;
                messageDiv.style.color = data.message ? "green" : "red";
        
                if (data.message) {
                    document.getElementById("addFolderForm").reset();
                }
            })
            .catch(error => console.error("L·ªói:", error));
            loadDiemDanhList();
        }
        
        
        
        function manualOpen() {
            let formData = new FormData(document.getElementById('manualOpenForm'));
    
            fetch("{% url 'manual_open' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let messageDiv = document.getElementById('manualMessage');
                messageDiv.innerText = data.message || data.error;
                messageDiv.style.color = data.message ? 'green' : 'red';
    
                if (data.success) {
                    loadDiemDanhList();
                    document.getElementById("manualOpenForm").reset();
                }
            })
            .catch(error => console.error('L·ªói:', error));
        }
        </script>
{% endblock main %} 
